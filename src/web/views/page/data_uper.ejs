<!DOCTYPE html>
<html>

<head>
    <title>UP</title>
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
    <link href="assets/styles.css" rel="stylesheet" media="screen">
    <link href="assets/DT_bootstrap.css" rel="stylesheet" media="screen">
    <link href="vendors/jGrowl/jquery.jgrowl.css" rel="stylesheet" media="screen">
    <!--[if lte IE 8]>
    <script language="javascript" type="text/javascript" src="vendors/flot/excanvas.min.js"></script><![endif]-->
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script src="vendors/modernizr-2.6.2-respond-1.1.0.min.js"></script>
</head>

<body>

<% include ../common/header.ejs %>

<div class="container-fluid">
    <div class="row-fluid">

        <% include ../common/navigation.ejs %>

        <div class="span9" id="content">


            <div class="row-fluid">
                <!-- block -->
                <div class="block">
                    <div class="navbar navbar-inner block-header">
                        <div class="muted pull-left"></div>
                    </div>
                    <div class="block-content collapse in">
                        <div class="span12">
                            <!-- Body -->

                            <div class="block">
                                <div class="navbar navbar-inner block-header">
                                    <div class="muted pull-left">输入UP主ID,查询UP主信息并可以加入关注</div>
                                </div>
                                <div class="block-content collapse in">
                                    <div class="span12">
                                        <form class="form-horizontal">
                                            <fieldset>
                                                <div class="control-group">
                                                    <label class="control-label" for="focusedInput">UP主ID</label>
                                                    <div class="controls">
                                                        <input class="input-xlarge focused" id="uperId" placeholder="请输入UP主ID " type="text" value="">
                                                        <button class="btn btn-info" style="margin-left: 50px;" onclick="searchUp();return false;">查询UP主</button>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <ul class="his-item">
                                                            <!--<li onclick="search();" id=""><i class="icon-tags"></i> </li>-->
                                                        </ul>
                                                    </div>
                                                </div>
                                            </fieldset>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!-- Body -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="row-fluid uper-info" style="display: none">
                <!-- block -->
                <div class="block">
                    <div class="navbar navbar-inner block-header">
                        <div class="muted pull-left">UP</div>
                    </div>
                    <div class="block-content collapse in">
                        <div class="span12">
                            <div  class="cartoon-detail">
                                <div id="" class="uper-bid" style="display:none;"></div>
                                <div>
                                    <label class="label label-info">头像 </label><img class="uper-face img-rounded" src=""/>
                                </div>
                                <div>
                                    <label class="label label-info">昵称 </label><em class="name"></em>
                                </div>
                                <div>
                                    <label class="label  label-info">等级 </label><em class="level"></em>
                                </div>
                                <div>
                                    <label class="label label-info">签名 </label><em class="sign"></em>
                                </div>
                                <div>
                                    <a class="btn uper-link" href="" target="_blank"><i class="icon-share-alt"></i>  跳转到主页 </a>
                                </div>
                                <div>
                                    <button class="btn btn-danger add-attention" onclick="add2AttentionUp();return false;"><i class="icon-star icon-white"></i>加入关注</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /block -->
            </div>

        </div>
    </div>
</div>

<script src="vendors/jquery-1.9.1.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="assets/scripts.js"></script>
<script src="vendors/jGrowl/jquery.jgrowl.js"></script>
<script>

  $(function(){
    showAttentionBtn(false)
//    showUperInfo(false)
    initHistory();
  })

  function showAttentionBtn(f){
    $(".add-attention").attr('disabled',!f);
  }

  function showUperInfo(f){
    $(".uper-info").css("display",f? "block": "none");
  }

  function searchUp(bid){
    let id = bid || $('#uperId').val();

    if(!id){
      alert("请输入ID")
      return;
    }

    if(!isStringNumber(id)){
      return alert('编号为数字串')
    }

    $.ajax({
      type : "get",
      contentType: "application/json;charset=UTF-8",
      url : "/api/search/uper/" + id ,
      success : function(result) {
        innerData(result)
        showAttentionBtn(true)
      },
      error : function(e){
        showUperInfo(false)
        showErrorMessage(e,$.jGrowl)
      }
    });
  }

  let mid = '';

  //海报 result.cover
  //mid result.media_id
  //origin_name result.origin_name
  //ratingCode result.rating.score
  //ratingCount result.rating.count
  //fans result.stat.favorites
  function innerData(result){
    $('.uper-face').attr("src",  "https://images.weserv.nl/?url=" + result.face)
    $('.name').empty().text(result.name)
    $('.uper-bid').empty().attr("id",result.bid)
    $('.level').empty().text(result.level)
    $('.sign').empty().text(result.sign)
    $('.uper-link').attr("href", "https://space.bilibili.com/" + result.bid)
    showUperInfo(true)
  }


  function add2AttentionUp(){
      let bid = $('.uper-bid').attr("id");
      let name = $('.name').text()

    let data = {
      bid,name
    }

    $.ajax({
      type : "post",
      url : "/api/attention/upers",
      data,
      success : function() {
        $.jGrowl("关注成功");
      },
      error : function(e){
        showErrorMessage(e, $.jGrowl)
      }
    });

  }

  function initHistory(){
    $.ajax({
      type : "get",
      url : "/api/search/history/2?limit=25",
      success : function(res) {
        initHistoryContent(res)
      },
      error : function(e){
        showErrorMessage(e)
      }
    });
  }

  function initHistoryContent(items){
    let content = '';
    for(let item of items){
      content += `<li onclick="search(`+ item.bid +`);"><i class="icon-tags"></i> ${item.name}</li>`
    }
    $('.his-item').html(content)
  }

  function search(bid){
    searchUp(bid)
  }

</script>
</body>

</html>
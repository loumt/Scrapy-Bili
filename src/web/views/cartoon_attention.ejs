<!DOCTYPE html>
<html>

<head>
    <title>UP</title>
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
    <link href="assets/styles.css" rel="stylesheet" media="screen">
    <link href="assets/DT_bootstrap.css" rel="stylesheet" media="screen">
    <!--[if lte IE 8]>
    <script language="javascript" type="text/javascript" src="vendors/flot/excanvas.min.js"></script><![endif]-->
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script src="vendors/modernizr-2.6.2-respond-1.1.0.min.js"></script>
</head>

<body>

<% include common/header.ejs %>

<div class="container-fluid">
    <div class="row-fluid">

        <% include common/navigation.ejs %>

        <div class="span9" id="content">
            <div class="row-fluid">
                <!-- block -->
                <div class="block">
                    <div class="navbar navbar-inner block-header">
                        <div class="muted pull-left"></div>
                    </div>
                    <div class="block-content collapse in">
                        <div class="span12">
                            <table cellpadding="0" cellspacing="0" border="0"
                                   class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>番名</th>
                                    <th>原番名</th>
                                    <th>评分</th>
                                    <th>评分人数</th>
                                    <th>追番人数</th>
                                    <th>更新时间</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody id="up-data">
                                </tbody>
                            </table>

                            <div class="pagination" style="text-align: right;"></div>
                        </div>
                    </div>
                </div>
                <!-- /block -->
            </div>

        </div>
    </div>
</div>
<!--/.fluid-container-->

<script src="vendors/jquery-1.9.1.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>


<script src="assets/scripts.js"></script>
<script src="assets/pagination.js"></script>
<script>
  var pageJson = {
    page: 1,
    limit: 20
  }


  function builderTbody(cartoons) {
    if (cartoons.length === 0) {
      return "";
    }
    let content = "";
    for(var i =0;i< cartoons.length; i++){
      content += ` <tr><td>${cartoons[i].mid}</td><td>${cartoons[i].name}</td><td>${cartoons[i].originName}</td><td>${cartoons[i].ratingCode}</td><td>${cartoons[i].ratingCount}</td><td>${cartoons[i].fans}</td><td>${utc2beijing(cartoons[i].utime)}</td><td><button class="btn btn-danger btn-mini" onclick="deleteAttention(this)" mid =${cartoons[i].id}>删除</button></td></tr>`
    }
    return content;
  }


  $(function(){
    initTable();
  });



  function initTable(){
    let options = {
      limit: pageJson.limit,
      page: pageJson.page
    }

    $.ajax({
      type : "get",
      contentType: "application/json;charset=UTF-8",
      url : "/cartoons" + "?limit=" + options.limit + "&page=" + options.page,
      //数据，json字符串
//        data : JSON.stringify(options),
      //请求成功
      success : function(result) {
        $('#up-data').html(builderTbody(result.rows))
        buildPagination(pageJson.page, pageJson.limit, result.count);
      },
      //请求失败，包含具体的错误信息
      error : function(e){
        console.log(e.status);
      }
    });
  }

  function deleteAttention(_this){
    let id = $(_this).attr('mid');
    if(!id)return;

    $.ajax({
      type : "delete",
      contentType: "application/json;charset=UTF-8",
      url : "/cartoons/" + id,
      success : function(result) {
        alert("删除成功")
        $('#up-data').empty();
        initTable()
      },
      error : function(e){
        console.log(e.status);
      }
    });

  }
</script>
</body>

</html>
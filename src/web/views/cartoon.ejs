<!DOCTYPE html>
<html>

<head>
    <title>UP</title>
    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" media="screen">
    <link href="assets/styles.css" rel="stylesheet" media="screen">
    <link href="assets/DT_bootstrap.css" rel="stylesheet" media="screen">
    <!--[if lte IE 8]>
    <script language="javascript" type="text/javascript" src="vendors/flot/excanvas.min.js"></script><![endif]-->
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script src="vendors/modernizr-2.6.2-respond-1.1.0.min.js"></script>
</head>

<body>

<% include common/header.ejs %>

<div class="container-fluid">
    <div class="row-fluid">

        <% include common/navigation.ejs %>

        <div class="span9" id="content">


            <div class="row-fluid">
                <!-- block -->
                <div class="block">
                    <div class="navbar navbar-inner block-header">
                        <div class="muted pull-left"></div>
                    </div>
                    <div class="block-content collapse in">
                        <div class="span12">
                            <!-- Body -->

                            <div class="block">
                                <div class="navbar navbar-inner block-header">
                                    <div class="muted pull-left">输入番剧ID,查询番剧信息并加入关注</div>
                                </div>
                                <div class="block-content collapse in">
                                    <div class="span12">
                                        <form class="form-horizontal">
                                            <fieldset>
                                                <div class="control-group">
                                                    <label class="control-label" for="focusedInput">番剧ID</label>
                                                    <div class="controls">
                                                        <input class="input-xlarge focused" id="cartoonId" placeholder="请输入番剧ID " type="text" value="">
                                                        <button class="btn btn-info" style="margin-left: 50px;" onclick="searchCartoon();return false;">查询番剧</button>
                                                    </div>
                                                </div>
                                                <div class="control-group">
                                                    <div class="controls">
                                                        <ul class="his-item"></ul>
                                                    </div>
                                                </div>
                                            </fieldset>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!-- Body -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="row-fluid cartoon-info" style="display: none">
                <!-- block -->
                <div class="block">
                    <div class="navbar navbar-inner block-header">
                        <div class="muted pull-left">番剧</div>
                    </div>
                    <div class="block-content collapse in">
                        <div class="span12">
                            <div style="display: block;width: 40%;height: 100%;float: left">
                                <img class="cartoon-img img-rounded" src=""/>
                            </div>


                            <!--//海报 result.cover-->
                            <!--//mid result.media_id-->
                            <!--//origin_name result.origin_name-->
                            <!--//ratingCode result.rating.score-->
                            <!--//ratingCount result.rating.count-->
                            <!--//fans result.stat.favorites-->
                            <div  class="cartoon-detail">
                                <div>
                                    <label class="label label-info">番剧 </label><em class="name"></em>
                                </div>
                                <div>
                                    <label class="label  label-info">原番名 </label><em class="origin-name"></em>
                                </div>
                                <div>
                                    <label class="label label-info">追番人数 </label><em class="fan-count"></em>
                                </div>
                                <div>
                                    <label class="label label-info">弹幕总数 </label><span class="danmakus"></span>
                                </div>
                                <div>
                                    <label class="label label-info">总播放数 </label><span class="views"></span>
                                </div>
                                <div>
                                    <label class="label label-info">评分 </label><em class="rating-code"></em>
                                </div>
                                <div>
                                    <label class="label label-info">评分人数 </label><span class="rating-count"></span>
                                </div>
                                <div>
                                    <label class="label label-info">开播时间 </label><span class="release_date_show"></span>
                                </div>
                                <div>
                                    <label class="label label-info">状态 </label><span class="time_length_show"></span>
                                </div>
                                <div>
                                    <label class="label label-info">类型 </label><span class="type_name"></span>
                                </div>
                                <div>
                                    <label class="label label-info">简介 </label><span class="evaluate"></span>
                                </div>
                                <div>
                                    <label class="label label-info">演员列表 </label><span class="actors"></span>
                                </div>
                                <div>
                                    <a class="btn cartoon-link" href="" target="_blank"><i class="icon-share-alt"></i> 跳转到主页 </a>
                                </div>
                                <div>
                                    <button class="btn btn-danger add-attention" onclick="add2Attention();return false;"><i class="icon-star icon-white"></i>加入关注</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /block -->
            </div>

        </div>
    </div>
</div>

<script src="vendors/jquery-1.9.1.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="assets/scripts.js"></script>
<script>

    $(function(){
      showAttentionBtn(false)
//      showCartoonInfo(false)
      initHistory();
    })

    function showAttentionBtn(f){
      $(".add-attention").attr('disabled',!f);
    }

    function showCartoonInfo(f){
      $(".cartoon-info").css("display",f? "block": "none");
    }

    function searchCartoon(bid){
      let id = bid || $('#cartoonId').val();

      if(!id){
        alert("请输入ID")
        return;
      }

      $.ajax({
        type : "get",
        contentType: "application/json;charset=UTF-8",
        url : "/cartoon/" + id ,
        success : function(result) {
          innerData(result)
          showAttentionBtn(true)
        },
        error : function(e){
          console.log(e)
          alert('Error')
        }
      });
    }

    let mid = '';

    //海报 result.cover
    //mid result.media_id
    //origin_name result.origin_name
    //ratingCode result.rating.score
    //ratingCount result.rating.count
    //fans result.stat.favorites
    function innerData(result){
      console.dir(result)
      $('.cartoon-img').attr("src",  "https://images.weserv.nl/?url=" + result.cover)

      if(result.rating){
        $('.rating-code').empty().text(result.rating.score)
        $('.rating-count').empty().text(result.rating.count)
      }else{
        $('.rating-code').empty()
        $('.rating-count').empty()
      }

      $('.name').empty().text(result.title)
      $('.origin-name').empty().text(result.origin_name)
      $('.fan-count').empty().text(result.stat.favorites)
      $('.danmakus').empty().text(result.stat.danmakus)
      $('.views').empty().text(result.stat.views)
      $('.actors').empty().text(result.actors)
      $('.evaluate').empty().text(result.evaluate)
      $('.release_date_show').empty().text(result.publish.release_date_show)
      $('.time_length_show').empty().text(result.publish.time_length_show)
      $('.type_name').empty().text(result.type_name)
      $('.cartoon-link').attr('href', 'https://www.bilibili.com/bangumi/media/md' + result.media_id)
      mid = result.media_id;
      showCartoonInfo(true)
    }


    function add2Attention(){
      let cartoonImg = $('.cartoon-img')[0].src
      let ratingCode = $('.rating-code').text()
      let ratingCount = $('.rating-count').text()
      let name = $('.name').text()
      let originName  = $('.origin-name').text()
      let fans = $('.fan-count').text()

      let data = {
        mid: mid,
        banner:cartoonImg,
        fans,
        name,originName
      }

      if(ratingCode){
        data.ratingCode = ratingCode
      }
      if(ratingCount){
        data.ratingCount = ratingCount
      }

      $.ajax({
        type : "post",
        url : "/cartoons",
        data,
        success : function() {
          alert("关注成功~");
        },
        error : function(e){
          if(e.responseText){
            let error = JSON.parse(e.responseText)
            if(error.code === 700){
              return alert("已在关注列表")
            }
          }
          alert('Error')
        }
      });

    }


    function initHistory(){
      $.ajax({
        type : "get",
        url : "/search/history/1?limit=25",
        success : function(res) {
          initHistoryContent(res)
        },
        error : function(e){
          alert('Error')
        }
      });
    }

    function initHistoryContent(items){
      let content = '';
      for(let item of items){
        content += `<li onclick="search(`+ item.bid +`);""><i class="icon-tags"></i> ${item.name}</li>`
      }
      $('.his-item').html(content)
    }

    function search(bid){
      searchCartoon(bid)
    }

</script>
</body>

</html>